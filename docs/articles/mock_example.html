<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mock community example â€¢ mbtools</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Mock community example">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mbtools</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.9.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/mock_example.html">Mock community example</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/Gibbons-Lab/mbtools">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Mock community example</h1>
                        <h4 class="author">Christian Diener</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/Gibbons-Lab/mbtools/blob/master/vignettes/mock_example.Rmd"><code>vignettes/mock_example.Rmd</code></a></small>
      <div class="hidden name"><code>mock_example.Rmd</code></div>

    </div>

    
    
<p>For installation instructions please see <a href="https://github.com/cdiener/microbiome" class="uri">https://github.com/cdiener/microbiome</a>. We recommend using the docker image in the cloud or locally as this ensures that all requirements are fulfilled in the correct version.</p>
<div id="loading-dependencies" class="section level2">
<h2 class="hasAnchor">
<a href="#loading-dependencies" class="anchor"></a>Loading dependencies</h2>
<p>In order to facilitate use of the pipeline we provide the <code>mbtools</code> R package in this repository which serves two major purposes:</p>
<ol style="list-style-type: decimal">
<li>It implements additional helper functions for the analysis and benchmarking of microbial community data.</li>
<li>It depends on all additional packages required for analysis and load them upon import.</li>
</ol>
<p>So loading <code>mbtools</code> should be the first step when running the analysis</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">library</span>(mbtools)</a></code></pre></div>
<pre><code>## Also loading: dada2 1.8.0
## Also loading: data.table 1.11.4
## Also loading: ggplot2 3.0.0
## Also loading: magrittr 1.5
## Also loading: phyloseq 1.24.2
## Also loading: ShortRead 1.38.0
## Also loading: yaml 2.2.0</code></pre>
<pre><code>## 
## Attaching package: 'mbtools'</code></pre>
<pre><code>## The following object is masked _by_ 'package:BiocGenerics':
## 
##     normalize</code></pre>
</div>
<div id="getting-the-mock-community-data" class="section level2">
<h2 class="hasAnchor">
<a href="#getting-the-mock-community-data" class="anchor"></a>Getting the mock community data</h2>
<p><code>mbtools</code> includes helper functions to obtain benchmark mock data sets from the <a href="https://peerj.com/preprints/2065/">mockrobiota database</a>. For instance to download the mock-3 data set (relatively small) we can use</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="cf">if</span> (<span class="op">!</span><span class="kw">file.exists</span>(<span class="st">"mock4.rds"</span>)) {</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">    mock &lt;-<span class="st"> </span><span class="kw"><a href="../reference/mockrobiota.html">mockrobiota</a></span>(<span class="st">"mock-4"</span>, <span class="st">"mock4"</span>)</a>
<a class="sourceLine" id="cb5-3" data-line-number="3">    <span class="kw">saveRDS</span>(mock, <span class="st">"mock4.rds"</span>)</a>
<a class="sourceLine" id="cb5-4" data-line-number="4">} <span class="cf">else</span> mock &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="st">"mock4.rds"</span>)</a></code></pre></div>
<p>Here <code>mock</code> now includes annotations for the data set as a list.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw">names</span>(mock)</a></code></pre></div>
<pre><code>##  [1] "description" "forward"     "reverse"     "index"       "citation"   
##  [6] "fragment"    "equipment"   "samples"     "ps_gg"       "ps_silva"</code></pre>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">mock<span class="op">$</span>samples</a></code></pre></div>
<pre><code>##                                      SampleID BarcodeSequence
## HMPMockV1.1.Even1           HMPMockV1.1.Even1    TGTACGGATAAC
## HMPMockV1.1.Even2           HMPMockV1.1.Even2    CAAATGGTCGTC
## HMPMockV1.2.Staggered1 HMPMockV1.2.Staggered1    AATCAACTAGGC
## HMPMockV1.2.Staggered2 HMPMockV1.2.Staggered2    ACACATAAGTCG
##                        LinkerPrimerSequence        ReversePrimer
## HMPMockV1.1.Even1       GTGCCAGCMGCCGCGGTAA GGACTACHVGGGTWTCTAAT
## HMPMockV1.1.Even2       GTGCCAGCMGCCGCGGTAA GGACTACHVGGGTWTCTAAT
## HMPMockV1.2.Staggered1  GTGCCAGCMGCCGCGGTAA GGACTACHVGGGTWTCTAAT
## HMPMockV1.2.Staggered2  GTGCCAGCMGCCGCGGTAA GGACTACHVGGGTWTCTAAT
##                        PrimerName Description
## HMPMockV1.1.Even1       515f-806r    Nenehozi
## HMPMockV1.1.Even2       515f-806r    Tofekoca
## HMPMockV1.2.Staggered1  515f-806r    Kalofiyo
## HMPMockV1.2.Staggered2  515f-806r    Pewizifo</code></pre>
</div>
<div id="preparing-the-reads" class="section level2">
<h2 class="hasAnchor">
<a href="#preparing-the-reads" class="anchor"></a>Preparing the reads</h2>
<p>As we can see we have 3 read files, the forward and backward reads and one index file mapping the sample barcodes to the sequences. However, we have 4 samples: a uniform and staggered community in duplicates each. In order to map sequence variants to samples <code>dada2</code> expects read files to be separated by sample. <code>mbtools</code> includes helper functions to obtain this splitting.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">reads &lt;-<span class="st"> </span><span class="kw">c</span>(mock<span class="op">$</span>forward, mock<span class="op">$</span>reverse)</a>
<a class="sourceLine" id="cb10-2" data-line-number="2">barcodes &lt;-<span class="st"> </span>mock<span class="op">$</span>samples<span class="op">$</span>BarcodeSequence</a>
<a class="sourceLine" id="cb10-3" data-line-number="3"><span class="kw">names</span>(barcodes) &lt;-<span class="st"> </span>mock<span class="op">$</span>samples[,<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb10-4" data-line-number="4">bcs &lt;-<span class="st"> </span><span class="kw"><a href="../reference/split_barcodes.html">split_barcodes</a></span>(reads, mock<span class="op">$</span>index, <span class="st">"split"</span>, barcodes)</a>
<a class="sourceLine" id="cb10-5" data-line-number="5">fwd &lt;-<span class="st"> </span><span class="kw">list.files</span>(<span class="st">"split"</span>, <span class="dt">pattern=</span><span class="st">"forward"</span>, <span class="dt">full.names=</span>T)</a>
<a class="sourceLine" id="cb10-6" data-line-number="6">bwd &lt;-<span class="st"> </span><span class="kw">list.files</span>(<span class="st">"split"</span>, <span class="dt">pattern=</span><span class="st">"reverse"</span>, <span class="dt">full.names=</span>T)</a>
<a class="sourceLine" id="cb10-7" data-line-number="7"></a>
<a class="sourceLine" id="cb10-8" data-line-number="8">fwd</a></code></pre></div>
<pre><code>## [1] "split/HMPMockV1.1.Even1_mock-forward-read.fastq.gz"     
## [2] "split/HMPMockV1.1.Even2_mock-forward-read.fastq.gz"     
## [3] "split/HMPMockV1.2.Staggered1_mock-forward-read.fastq.gz"
## [4] "split/HMPMockV1.2.Staggered2_mock-forward-read.fastq.gz"</code></pre>
<p>As we see that now gives us the reads separated by sample. The orginal read still include some valid information, particularly they include the read qualities across all samples.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="kw">plotQualityProfile</span>(reads[<span class="dv">1</span>])</a></code></pre></div>
<p><img src="mock_example_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="kw">plotQualityProfile</span>(reads[<span class="dv">2</span>])</a></code></pre></div>
<p><img src="mock_example_files/figure-html/unnamed-chunk-5-2.png" width="700"></p>
<p>As we can see both qualities detoriate extremely with read lengths. Thus, we will have to trim the reads. From the plots we can see that the forward reads have decent quality up to a length of 150 bp whereas the reverse reads are acceptable up to 100 bp.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="kw">dir.create</span>(<span class="st">"filtered"</span>)</a></code></pre></div>
<pre><code>## Warning in dir.create("filtered"): 'filtered' already exists</code></pre>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1">fwd_filt &lt;-<span class="st"> </span><span class="kw">file.path</span>(<span class="st">"filtered"</span>, <span class="kw">basename</span>(fwd))</a>
<a class="sourceLine" id="cb16-2" data-line-number="2">bwd_filt &lt;-<span class="st"> </span><span class="kw">file.path</span>(<span class="st">"filtered"</span>, <span class="kw">basename</span>(bwd))</a>
<a class="sourceLine" id="cb16-3" data-line-number="3">filt &lt;-<span class="st"> </span><span class="kw">filterAndTrim</span>(fwd, fwd_filt, bwd, bwd_filt,</a>
<a class="sourceLine" id="cb16-4" data-line-number="4">                      <span class="dt">trimLeft=</span><span class="dv">10</span>, <span class="dt">truncLen=</span><span class="kw">c</span>(<span class="dv">140</span>, <span class="dv">100</span>),</a>
<a class="sourceLine" id="cb16-5" data-line-number="5">                      <span class="dt">compress=</span>T, <span class="dt">multithread=</span>T)</a>
<a class="sourceLine" id="cb16-6" data-line-number="6">filt</a></code></pre></div>
<pre><code>##                                                   reads.in reads.out
## HMPMockV1.1.Even1_mock-forward-read.fastq.gz       1236898   1216195
## HMPMockV1.1.Even2_mock-forward-read.fastq.gz        808308    797208
## HMPMockV1.2.Staggered1_mock-forward-read.fastq.gz   838791    825665
## HMPMockV1.2.Staggered2_mock-forward-read.fastq.gz   918465    905396</code></pre>
<p>We will follow by dereplicating the reads which will yield the unique sequences in the samples.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1">derepFs &lt;-<span class="st"> </span><span class="kw">derepFastq</span>(fwd_filt, <span class="dt">verbose=</span><span class="ot">TRUE</span>)</a></code></pre></div>
<pre><code>## Dereplicating sequence entries in Fastq file: filtered/HMPMockV1.1.Even1_mock-forward-read.fastq.gz</code></pre>
<pre><code>## .Encountered 95580 unique sequences from 1216195 total sequences read.
## Dereplicating sequence entries in Fastq file: filtered/HMPMockV1.1.Even2_mock-forward-read.fastq.gz
## Encountered 72797 unique sequences from 797208 total sequences read.
## Dereplicating sequence entries in Fastq file: filtered/HMPMockV1.2.Staggered1_mock-forward-read.fastq.gz
## Encountered 76415 unique sequences from 825665 total sequences read.
## Dereplicating sequence entries in Fastq file: filtered/HMPMockV1.2.Staggered2_mock-forward-read.fastq.gz
## Encountered 72114 unique sequences from 905396 total sequences read.</code></pre>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1">derepRs &lt;-<span class="st"> </span><span class="kw">derepFastq</span>(bwd_filt, <span class="dt">verbose=</span><span class="ot">TRUE</span>)</a></code></pre></div>
<pre><code>## Dereplicating sequence entries in Fastq file: filtered/HMPMockV1.1.Even1_mock-reverse-read.fastq.gz
## .Encountered 106375 unique sequences from 1216195 total sequences read.
## Dereplicating sequence entries in Fastq file: filtered/HMPMockV1.1.Even2_mock-reverse-read.fastq.gz
## Encountered 68054 unique sequences from 797208 total sequences read.
## Dereplicating sequence entries in Fastq file: filtered/HMPMockV1.2.Staggered1_mock-reverse-read.fastq.gz
## Encountered 80575 unique sequences from 825665 total sequences read.
## Dereplicating sequence entries in Fastq file: filtered/HMPMockV1.2.Staggered2_mock-reverse-read.fastq.gz
## Encountered 70459 unique sequences from 905396 total sequences read.</code></pre>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1"><span class="co"># Name the derep-class objects by the sample names</span></a>
<a class="sourceLine" id="cb23-2" data-line-number="2"><span class="kw">names</span>(derepFs) &lt;-<span class="st"> </span><span class="kw">names</span>(derepRs) &lt;-<span class="st"> </span><span class="kw">names</span>(barcodes)</a></code></pre></div>
</div>
<div id="obtaining-the-sequence-variants-sequence-otus" class="section level2">
<h2 class="hasAnchor">
<a href="#obtaining-the-sequence-variants-sequence-otus" class="anchor"></a>Obtaining the sequence variants (sequence OTUs)</h2>
<p>With the trimmed and dereplicated reads we can now advance to running the dada2 algorithm to discover the unique sequence variants in our reads. We will do this separately for the forward and backward reads.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" data-line-number="1">dadaFs &lt;-<span class="st"> </span><span class="kw">dada</span>(derepFs, <span class="dt">err=</span><span class="ot">NULL</span>, <span class="dt">selfConsist =</span> <span class="ot">TRUE</span>, <span class="dt">multithread =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<pre><code>## Initializing error rates to maximum possible estimate.
## selfConsist step 1 ....
##    selfConsist step 2
##    selfConsist step 3
##    selfConsist step 4
##    selfConsist step 5
##    selfConsist step 6
##    selfConsist step 7
##    selfConsist step 8
## Convergence after  8  rounds.</code></pre>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" data-line-number="1">dadaRs &lt;-<span class="st"> </span><span class="kw">dada</span>(derepRs, <span class="dt">err=</span><span class="ot">NULL</span>, <span class="dt">selfConsist =</span> <span class="ot">TRUE</span>, <span class="dt">multithread =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<pre><code>## Initializing error rates to maximum possible estimate.
## selfConsist step 1 ....
##    selfConsist step 2
##    selfConsist step 3
##    selfConsist step 4
##    selfConsist step 5
##    selfConsist step 6
##    selfConsist step 7
## Convergence after  7  rounds.</code></pre>
<p>This will fit an error model that deconvolutes the original sequence variants in the sample. We can investigate how well the error model reproduces our data as well.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" data-line-number="1"><span class="kw">plotErrors</span>(dadaFs, <span class="dt">nominalQ=</span><span class="ot">TRUE</span>)</a></code></pre></div>
<pre><code>## Warning: Transformation introduced infinite values in continuous y-axis</code></pre>
<p><img src="mock_example_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" data-line-number="1"><span class="kw">plotErrors</span>(dadaRs, <span class="dt">nominalQ=</span><span class="ot">TRUE</span>)</a></code></pre></div>
<pre><code>## Warning: Transformation introduced infinite values in continuous y-axis</code></pre>
<p><img src="mock_example_files/figure-html/unnamed-chunk-9-2.png" width="700"></p>
<p>We will now quantify the sequence variants for both samples and combine them. Normally we would try to actually combine the forward and backwards reads into larger reads and quantify those, however our read qualities were so bad in this data set that there is no sufficient overlap. Thus, we will treat the forward and backward reads independently.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb32-1" data-line-number="1">seqtab_fwd &lt;-<span class="st"> </span><span class="kw">makeSequenceTable</span>(dadaFs)</a>
<a class="sourceLine" id="cb32-2" data-line-number="2">seqtab_bwd &lt;-<span class="st"> </span><span class="kw">makeSequenceTable</span>(dadaRs)</a>
<a class="sourceLine" id="cb32-3" data-line-number="3">seqtab &lt;-<span class="st"> </span><span class="kw">cbind</span>(seqtab_fwd, seqtab_bwd)</a></code></pre></div>
<p>Finally, we will also remove bimeras (reads that are combinations of two other reads) from the data set. We will also save the sequence table for later use.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" data-line-number="1">seqtab_nochim &lt;-<span class="st"> </span><span class="kw">removeBimeraDenovo</span>(seqtab, <span class="dt">verbose=</span><span class="ot">TRUE</span>)</a></code></pre></div>
<pre><code>## Identified 292 bimeras out of 432 input sequences.</code></pre>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" data-line-number="1"><span class="kw">saveRDS</span>(seqtab_nochim, <span class="st">"svs.rds"</span>)</a></code></pre></div>
</div>
<div id="taxonomy-assignment-and-validation" class="section level2">
<h2 class="hasAnchor">
<a href="#taxonomy-assignment-and-validation" class="anchor"></a>Taxonomy assignment and validation</h2>
<p>In order to classify taxonomies for the individual sequence variants we will use the RDP algorithm with the green genes reference sequences. If you do not use the docker image this data set has to be downloaded first <a href="http://doi.org/10.5281/zenodo.158955">from here</a>.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb36-1" data-line-number="1"><span class="cf">if</span> (<span class="op">!</span><span class="kw">file.exists</span>(<span class="st">"gg_138.fa.gz"</span>))</a>
<a class="sourceLine" id="cb36-2" data-line-number="2">    <span class="kw">download.file</span>(<span class="st">"https://zenodo.org/record/158955/files/gg_13_8_train_set_97.fa.gz"</span>,</a>
<a class="sourceLine" id="cb36-3" data-line-number="3">        <span class="st">"gg_138.fa.gz"</span>)</a></code></pre></div>
<p>Taxonomies can now be assigned by</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" data-line-number="1">taxa &lt;-<span class="st"> </span><span class="kw">assignTaxonomy</span>(seqtab_nochim, <span class="st">"gg_138.fa.gz"</span>, <span class="dt">multithread=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb37-2" data-line-number="2"><span class="kw">colnames</span>(taxa) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"Kingdom"</span>, <span class="st">"Phylum"</span>, <span class="st">"Class"</span>, <span class="st">"Order"</span>, <span class="st">"Family"</span>, <span class="st">"Genus"</span>, <span class="st">"Species"</span>)</a>
<a class="sourceLine" id="cb37-3" data-line-number="3"><span class="kw">head</span>(<span class="kw">unname</span>(taxa))</a></code></pre></div>
<pre><code>##      [,1]          [,2]                [,3]                    
## [1,] "k__Bacteria" "p__Firmicutes"     "c__Bacilli"            
## [2,] "k__Bacteria" "p__Proteobacteria" "c__Gammaproteobacteria"
## [3,] "k__Bacteria" "p__Firmicutes"     "c__Bacilli"            
## [4,] "k__Bacteria" "p__Proteobacteria" "c__Alphaproteobacteria"
## [5,] "k__Bacteria" "p__Proteobacteria" "c__Gammaproteobacteria"
## [6,] "k__Bacteria" "p__[Thermi]"       "c__Deinococci"         
##      [,4]                   [,5]                    [,6]               
## [1,] "o__Bacillales"        "f__Staphylococcaceae"  "g__Staphylococcus"
## [2,] "o__Pseudomonadales"   "f__Moraxellaceae"      "g__Acinetobacter" 
## [3,] "o__Lactobacillales"   "f__Streptococcaceae"   "g__Streptococcus" 
## [4,] "o__Rhodobacterales"   "f__Rhodobacteraceae"   "g__Rhodobacter"   
## [5,] "o__Enterobacteriales" "f__Enterobacteriaceae" "g__Escherichia"   
## [6,] "o__Deinococcales"     "f__Deinococcaceae"     "g__Deinococcus"   
##      [,7]            
## [1,] "s__"           
## [2,] "s__guillouiae" 
## [3,] "s__"           
## [4,] "s__sphaeroides"
## [5,] "s__coli"       
## [6,] "s__"</code></pre>
<p>Since we used the green genes database there are some assignments which are actually empty such as the "s__" species. We will convert them to their correct NA value.</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb39-1" data-line-number="1">taxa[<span class="kw">grep</span>(<span class="st">"__$"</span>, taxa)] &lt;-<span class="st"> </span><span class="ot">NA</span></a></code></pre></div>
<p>The taxa assignments can be combined with quantifications using the phyloseq package.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb40-1" data-line-number="1">ps &lt;-<span class="st"> </span><span class="kw">phyloseq</span>(<span class="kw">otu_table</span>(seqtab_nochim, <span class="dt">taxa_are_rows=</span><span class="ot">FALSE</span>),</a>
<a class="sourceLine" id="cb40-2" data-line-number="2">               <span class="kw">tax_table</span>(taxa))</a></code></pre></div>
<p>We can now compare this table to our reference table from mockrobiota. We will start by quantifying how many of the real taxa were found in our taxonomy assignment.</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb41-1" data-line-number="1"><span class="kw"><a href="../reference/taxa_metrics.html">taxa_metrics</a></span>(<span class="kw">tax_table</span>(ps), <span class="kw">tax_table</span>(mock<span class="op">$</span>ps_gg))</a></code></pre></div>
<pre><code>##     level precision recall        F1 n_exp n_ref
## 1 Kingdom 1.0000000   1.00 1.0000000     2     2
## 2  Phylum 0.8571429   1.00 0.9230769     7     6
## 3   Class 0.8333333   1.00 0.9090909    12    10
## 4   Order 0.6666667   1.00 0.8000000    18    12
## 5  Family 0.6666667   1.00 0.8000000    27    18
## 6   Genus 0.6666667   1.00 0.8000000    27    18
## 7 Species 0.5294118   0.45 0.4864865    17    20</code></pre>
<p>As we can see we are pretty good in identifying the taxa in our samples. However, how do we perform in terms of taxa quantities? We will start by stratifying across the samples:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb43-1" data-line-number="1">tq &lt;-<span class="st"> </span><span class="kw"><a href="../reference/taxa_quants.html">taxa_quants</a></span>(ps, mock<span class="op">$</span>ps_gg, <span class="dt">normalize =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb43-2" data-line-number="2"><span class="kw">head</span>(tq)</a></code></pre></div>
<pre><code>##     level        name                 sample    measured  reference
## 1 Kingdom k__Bacteria      HMPMockV1.1.Even1 0.952576814 0.95238095
## 2 Kingdom  k__Archaea      HMPMockV1.1.Even1 0.018616473 0.04761905
## 3 Kingdom k__Bacteria      HMPMockV1.1.Even2 0.982652731 0.95238095
## 4 Kingdom  k__Archaea      HMPMockV1.1.Even2 0.001401979 0.04761905
## 5 Kingdom k__Bacteria HMPMockV1.2.Staggered1 0.982056771 0.78563773
## 6 Kingdom  k__Archaea HMPMockV1.2.Staggered1 0.001586491 0.21436227</code></pre>
<p><code>taxa_quants</code> already quantifies across a possible levels of taxonomy. So we can plot the performance stratified by sample with</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb45-1" data-line-number="1"><span class="kw">ggplot</span>(tq, <span class="kw">aes</span>(<span class="dt">x=</span>reference, <span class="dt">y=</span>measured, <span class="dt">col=</span>level)) <span class="op">+</span></a>
<a class="sourceLine" id="cb45-2" data-line-number="2"><span class="st">    </span><span class="kw">geom_abline</span>(<span class="dt">alpha=</span><span class="fl">0.5</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb45-3" data-line-number="3"><span class="st">    </span><span class="kw">geom_smooth</span>(<span class="kw">aes</span>(<span class="dt">group=</span><span class="dv">1</span>), <span class="dt">method=</span><span class="st">"lm"</span>, <span class="dt">lty=</span><span class="st">"dashed"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb45-4" data-line-number="4"><span class="st">    </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb45-5" data-line-number="5"><span class="st">    </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="st"> </span>sample)</a></code></pre></div>
<p><img src="mock_example_files/figure-html/unnamed-chunk-18-1.png" width="700"></p>
<p>This plot is so common that it is also implemented in <code>mbtools</code> as <code>mock_plot</code>.</p>
<p>Additionally, we can also combine all samples and rather stratify by taxonomy level.</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb46-1" data-line-number="1"><span class="kw">ggplot</span>(tq, <span class="kw">aes</span>(<span class="dt">x=</span>reference, <span class="dt">y=</span>measured, <span class="dt">col=</span>sample)) <span class="op">+</span></a>
<a class="sourceLine" id="cb46-2" data-line-number="2"><span class="st">    </span><span class="kw">geom_abline</span>(<span class="dt">alpha=</span><span class="fl">0.5</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb46-3" data-line-number="3"><span class="st">    </span><span class="kw">geom_smooth</span>(<span class="kw">aes</span>(<span class="dt">group=</span><span class="dv">1</span>), <span class="dt">method=</span><span class="st">"lm"</span>, <span class="dt">lty=</span><span class="st">"dashed"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb46-4" data-line-number="4"><span class="st">    </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb46-5" data-line-number="5"><span class="st">    </span><span class="kw">theme</span>(<span class="dt">legend.position=</span><span class="st">"bottom"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb46-6" data-line-number="6"><span class="st">    </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="st"> </span>level, <span class="dt">scale=</span><span class="st">"free"</span>)</a></code></pre></div>
<p><img src="mock_example_files/figure-html/unnamed-chunk-19-1.png" width="700"></p>
<p>This looks pretty ok with larger variations on the species level, which is to be expected. We can quantify the performance by a correlation test.</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb47-1" data-line-number="1"><span class="kw">cor.test</span>(tq<span class="op">$</span>measured, tq<span class="op">$</span>reference)</a></code></pre></div>
<pre><code>## 
##  Pearson's product-moment correlation
## 
## data:  tq$measured and tq$reference
## t = 27.086, df = 298, p-value &lt; 2.2e-16
## alternative hypothesis: true correlation is not equal to 0
## 95 percent confidence interval:
##  0.8071293 0.8731521
## sample estimates:
##       cor 
## 0.8432932</code></pre>
<p>So we get a correlation of about 0.85 which is okay for the bad quality reads we used here.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#loading-dependencies">Loading dependencies</a></li>
      <li><a href="#getting-the-mock-community-data">Getting the mock community data</a></li>
      <li><a href="#preparing-the-reads">Preparing the reads</a></li>
      <li><a href="#obtaining-the-sequence-variants-sequence-otus">Obtaining the sequence variants (sequence OTUs)</a></li>
      <li><a href="#taxonomy-assignment-and-validation">Taxonomy assignment and validation</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Christian Diener.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
